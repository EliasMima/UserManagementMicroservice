
pipeline {
    agent any
    
    environment {
        // Service-specific configuration
        SERVICE_NAME = 'api-gateway'
        SERVICE_PORT = '8001'
        
        // Docker Hub configuration
        DOCKERHUB_CREDENTIALS = credentials('89df4834-57b8-4fe8-9e25-d8775421a081')
        DOCKERHUB_USERNAME = 'eliaseji' 
        IMAGE_NAME = "${DOCKERHUB_USERNAME}/${SERVICE_NAME}"
        IMAGE_TAG = "${BUILD_NUMBER}"
        
        // Backend service URLs
        USER_SERVICE_URL = 'http://user-service:8003'
        NOTIFICATION_SERVICE_URL = 'http://notification-service:8002'
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
        timeout(time: 15, unit: 'MINUTES')
    }
    
    stages {
        // ========================================
        // STAGE 1: CHECKOUT
        // ========================================
        stage('Checkout') {
            steps {
                echo '========================================='
                echo "Building ${SERVICE_NAME}"
                echo "Version: ${IMAGE_TAG}"
                echo '========================================='
                checkout scm
                
                script {
                    def changes = sh(
                        script: "git diff --name-only HEAD~1 HEAD | grep '^${SERVICE_NAME}/' || true",
                        returnStdout: true
                    ).trim()
                    
                    if (changes) {
                        echo "✅ Changes detected in ${SERVICE_NAME}"
                    }
                }
            }
        }
        
        // ========================================
        // STAGE 2: INSTALL DEPENDENCIES
        // ========================================
        stage('Install Dependencies') {
            steps {
                echo "Installing dependencies..."
                dir(SERVICE_NAME) {
                    sh '''
                        node --version
                        npm --version
                        npm ci --prefer-offline
                        echo "✅ Dependencies installed"
                    '''
                }
            }
        }
        
        // ========================================
        // STAGE 3: LINTING
        // ========================================
        stage('Lint') {
            steps {
                dir(SERVICE_NAME) {
                    sh 'npm run lint --if-present || echo "No linting configured"'
                }
            }
        }
        
        // ========================================
        // STAGE 4: RUN TESTS
        // ========================================
        stage('Run Tests') {
            steps {
                echo "Running tests..."
                dir(SERVICE_NAME) {
                    sh '''
                        # Jest tests
                        npm test || echo "No Jest tests"
                        
                        # pytest if available
                        if [ -f "requirements.txt" ]; then
                            pip3 install -q -r requirements.txt
                            pytest tests/ -v --cov=src --cov-report=term || echo "No pytest tests"
                        fi
                        
                        echo "✅ Tests completed"
                    '''
                }
            }
        }
        
        // ========================================
        // STAGE 5: SECURITY SCAN
        // ========================================
        stage('Security Scan') {
            steps {
                dir(SERVICE_NAME) {
                    sh 'npm audit --audit-level=high || echo "⚠️ Vulnerabilities found"'
                }
            }
        }
        
        // ========================================
        // STAGE 6: BUILD DOCKER IMAGE
        // ========================================
        stage('Build Docker Image') {
            steps {
                echo "Building Docker image..."
                dir(SERVICE_NAME) {
                    sh """
                        docker build \
                            -t ${IMAGE_NAME}:${IMAGE_TAG} \
                            -t ${IMAGE_NAME}:latest \
                            --build-arg BUILD_DATE=\$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
                            --build-arg VERSION=${IMAGE_TAG} \
                            .
                        
                        echo "✅ Image built"
                    """
                }
            }
        }
        
        // ========================================
        // STAGE 7: TEST DOCKER IMAGE
        // ========================================
        stage('Test Docker Image') {
            steps {
                sh """
                    docker run -d \
                        --name ${SERVICE_NAME}-test-${BUILD_NUMBER} \
                        -p ${SERVICE_PORT}:${SERVICE_PORT} \
                        -e USER_SERVICE_URL=${USER_SERVICE_URL} \
                        -e NOTIFICATION_SERVICE_URL=${NOTIFICATION_SERVICE_URL} \
                        ${IMAGE_NAME}:${IMAGE_TAG}
                    
                    sleep 5
                    curl -f http://localhost:${SERVICE_PORT}/health || exit 1
                    
                    docker stop ${SERVICE_NAME}-test-${BUILD_NUMBER}
                    docker rm ${SERVICE_NAME}-test-${BUILD_NUMBER}
                    
                    echo "✅ Docker image tested"
                """
            }
        }
        
        // ========================================
        // STAGE 8: PUSH TO DOCKER HUB
        // ========================================
        stage('Push to Docker Hub') {
            steps {
                sh """
                    echo \$DOCKERHUB_CREDENTIALS_PSW | docker login -u \$DOCKERHUB_CREDENTIALS_USR --password-stdin
                    docker push ${IMAGE_NAME}:${IMAGE_TAG}
                    docker push ${IMAGE_NAME}:latest
                    echo "✅ Images pushed"
                """
            }
        }
        
        // ========================================
        // STAGE 9: DEPLOY
        // ========================================
        stage('Deploy') {
            when {
                branch 'main'
            }
            steps {
                sh """
                    # API Gateway needs backend services running
                    # Make sure they're up
                    docker-compose up -d user-service notification-service
                    
                    # Now deploy gateway
                    docker-compose stop ${SERVICE_NAME} || true
                    docker-compose rm -f ${SERVICE_NAME} || true
                    docker-compose pull ${SERVICE_NAME}
                    docker-compose up -d ${SERVICE_NAME}
                    
                    sleep 15  # Gateway needs backends ready
                    curl -f http://localhost:${SERVICE_PORT}/health || exit 1
                    
                    echo "✅ ${SERVICE_NAME} deployed"
                """
            }
        }
        
        // ========================================
        // STAGE 10: INTEGRATION TESTS
        // ========================================
        stage('Integration Tests') {
            when {
                branch 'main'
            }
            steps {
                sh """
                    # Test gateway health
                    curl -f http://localhost:${SERVICE_PORT}/health
                    
                    # Test root endpoint
                    curl -f http://localhost:${SERVICE_PORT}/
                    
                    # Test proxying to user service
                    curl -f http://localhost:${SERVICE_PORT}/api/users
                    
                    # Test proxying to notification service
                    curl -f http://localhost:${SERVICE_PORT}/api/notifications
                    
                    # Test creating user through gateway
                    curl -f -X POST http://localhost:${SERVICE_PORT}/api/users \
                        -H "Content-Type: application/json" \
                        -d '{"name":"Gateway Test","email":"gateway@test.com"}' \
                        || echo "⚠️ Create user test failed"
                    
                    echo "✅ Integration tests passed"
                """
            }
        }
        
        // ========================================
        // STAGE 11: SMOKE TESTS
        // ========================================
        stage('Smoke Tests') {
            when {
                branch 'main'
            }
            steps {
                echo "Running smoke tests..."
                sh """
                    # Test all critical endpoints
                    ENDPOINTS=(
                        "/"
                        "/health"
                        "/api/users"
                        "/api/notifications"
                    )
                    
                    for endpoint in "\${ENDPOINTS[@]}"; do
                        echo "Testing \$endpoint..."
                        if curl -f -s http://localhost:${SERVICE_PORT}\$endpoint > /dev/null; then
                            echo "  ✅ \$endpoint OK"
                        else
                            echo "  ❌ \$endpoint FAILED"
                            exit 1
                        fi
                    done
                    
                    echo "✅ All smoke tests passed"
                """
            }
        }
    }
    
    post {
        always {
            sh """
                docker logout || true
                docker rm -f ${SERVICE_NAME}-test-${BUILD_NUMBER} 2>/dev/null || true
            """
            cleanWs()
        }
        
        success {
            echo '========================================='
            echo "✅ ${SERVICE_NAME} BUILD SUCCESSFUL!"
            echo '========================================='
            echo "Image: ${IMAGE_NAME}:${IMAGE_TAG}"
            echo "Gateway URL: http://localhost:${SERVICE_PORT}"
        }
        
        failure {
            echo '========================================='
            echo "❌ ${SERVICE_NAME} BUILD FAILED!"
            echo '========================================='
        }
    }
}