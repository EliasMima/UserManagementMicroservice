

pipeline {
    agent any
    
    environment {
        // Service-specific configuration
        SERVICE_NAME = 'user-service'
        SERVICE_PORT = '8003'
        
        // Docker Hub configuration
        DOCKERHUB_CREDENTIALS = credentials('89df4834-57b8-4fe8-9e25-d8775421a081')
        DOCKERHUB_USERNAME = 'eliaseji'
        IMAGE_NAME = "${DOCKERHUB_USERNAME}/${SERVICE_NAME}"
        IMAGE_TAG = "${BUILD_NUMBER}"
        
        // Dependent services URLs (for integration tests)
        USER_SERVICE_URL = 'http://user-service:8003'
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
        timeout(time: 15, unit: 'MINUTES')  // Shorter timeout for single service
    }
    
    stages {
        // ========================================
        // STAGE 1: CHECKOUT
        // ========================================
        stage('Checkout') {
            steps {
                echo '========================================='
                echo "Building ${SERVICE_NAME}"
                echo "Version: ${IMAGE_TAG}"
                echo '========================================='
                checkout scm
                
                // Check if service files changed
                script {
                    def changes = sh(
                        script: "git diff --name-only HEAD~1 HEAD | grep '^${SERVICE_NAME}/' || true",
                        returnStdout: true
                    ).trim()
                    
                    if (changes) {
                        echo "✅ Changes detected in ${SERVICE_NAME}:"
                        echo changes
                    } else {
                        echo "ℹ️ No changes in ${SERVICE_NAME}, but building anyway"
                    }
                }
            }
        }
        
        // ========================================
        // STAGE 2: INSTALL DEPENDENCIES
        // ========================================
        stage('Install Dependencies') {
            steps {
                echo "Installing dependencies for ${SERVICE_NAME}..."
                dir(SERVICE_NAME) {
                    sh '''
                        echo "Node version: $(node --version)"
                        echo "npm version: $(npm --version)"
                        
                        # Clean install
                        npm ci --prefer-offline
                        
                        echo "✅ Dependencies installed"
                    '''
                }
            }
        }
        
        // ========================================
        // STAGE 3: LINTING (Optional)
        // ========================================
        stage('Lint') {
            steps {
                echo "Running linter for ${SERVICE_NAME}..."
                dir(SERVICE_NAME) {
                    sh '''
                        # Run eslint if configured
                        npm run lint --if-present || echo "No linting configured"
                    '''
                }
            }
        }
        
        // ========================================
        // STAGE 4: RUN TESTS
        // ========================================
        stage('Run Tests') {
            steps {
                echo "Running tests for ${SERVICE_NAME}..."
                dir(SERVICE_NAME) {
                    sh '''
                        # JavaScript tests (Jest)
                        npm test || echo "No Jest tests found"
                        
                        # Python tests (pytest) if available
                        if [ -f "requirements.txt" ]; then
                            pip3 install -q -r requirements.txt
                            pytest tests/ -v --cov=src --cov-report=term || echo "No pytest tests found"
                        fi
                    '''
                }
            }
        }
        
        // ========================================
        // STAGE 5: SECURITY SCAN (Optional)
        // ========================================
        stage('Security Scan') {
            steps {
                echo "Running security audit..."
                dir(SERVICE_NAME) {
                    sh '''
                        # npm audit
                        npm audit --audit-level=high || echo "⚠️ Security vulnerabilities found"
                        
                        # List for review but don't fail build
                        echo "Security scan complete - review above output"
                    '''
                }
            }
        }
        
        // ========================================
        // STAGE 6: BUILD DOCKER IMAGE
        // ========================================
        stage('Build Docker Image') {
            steps {
                echo "Building Docker image for ${SERVICE_NAME}..."
                dir(SERVICE_NAME) {
                    sh """
                        docker build \
                            -t ${IMAGE_NAME}:${IMAGE_TAG} \
                            -t ${IMAGE_NAME}:latest \
                            --build-arg BUILD_DATE=\$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
                            --build-arg VERSION=${IMAGE_TAG} \
                            .
                        
                        echo "✅ Image built: ${IMAGE_NAME}:${IMAGE_TAG}"
                    """
                }
            }
        }
        
        // ========================================
        // STAGE 7: TEST DOCKER IMAGE
        // ========================================
        stage('Test Docker Image') {
            steps {
                echo "Testing Docker image..."
                sh """
                    # Start container for testing
                    docker run -d \
                        --name ${SERVICE_NAME}-test-${BUILD_NUMBER} \
                        -p ${SERVICE_PORT}:${SERVICE_PORT} \
                        ${IMAGE_NAME}:${IMAGE_TAG}
                    
                    # Wait for service to start
                    sleep 5
                    
                    # Health check
                    curl -f http://localhost:${SERVICE_PORT}/health || exit 1
                    
                    echo "✅ Docker image health check passed"
                    
                    # Cleanup test container
                    docker stop ${SERVICE_NAME}-test-${BUILD_NUMBER}
                    docker rm ${SERVICE_NAME}-test-${BUILD_NUMBER}
                """
            }
        }
        
        // ========================================
        // STAGE 8: PUSH TO DOCKER HUB
        // ========================================
        stage('Push to Docker Hub') {
            steps {
                echo "Pushing ${SERVICE_NAME} to Docker Hub..."
                sh """
                    # Login
                    echo \$DOCKERHUB_CREDENTIALS_PSW | docker login -u \$DOCKERHUB_CREDENTIALS_USR --password-stdin
                    
                    # Push both tags
                    docker push ${IMAGE_NAME}:${IMAGE_TAG}
                    docker push ${IMAGE_NAME}:latest
                    
                    echo "✅ Images pushed to Docker Hub"
                """
            }
        }
        
        // ========================================
        // STAGE 9: DEPLOY
        // ========================================
        stage('Deploy') {
            when {
                branch 'main'  // Only deploy from main branch
            }
            steps {
                echo "Deploying ${SERVICE_NAME}..."
                script {
                    sh """
                        # Update service using docker-compose
                        docker-compose stop ${SERVICE_NAME} || true
                        docker-compose rm -f ${SERVICE_NAME} || true
                        docker-compose pull ${SERVICE_NAME}
                        docker-compose up -d ${SERVICE_NAME}
                        
                        # Wait for service
                        echo "Waiting for ${SERVICE_NAME} to be ready..."
                        sleep 10
                        
                        # Health check
                        curl -f http://localhost:${SERVICE_PORT}/health || exit 1
                        
                        echo "✅ ${SERVICE_NAME} deployed successfully"
                    """
                }
            }
        }
        
        // ========================================
        // STAGE 10: INTEGRATION TESTS
        // ========================================
        stage('Integration Tests') {
            when {
                branch 'main'
            }
            steps {
                echo "Running integration tests..."
                sh """
                    # Test service endpoints
                    curl -f http://localhost:${SERVICE_PORT}/health
                    
            }
        }
        
    
    // ========================================
    // POST-BUILD ACTIONS
    // ========================================
    post {
        always {
            echo "Cleaning up..."
            sh """
                # Logout from Docker Hub
                docker logout || true
                
                # Remove test containers if any
                docker rm -f ${SERVICE_NAME}-test-${BUILD_NUMBER} 2>/dev/null || true
                
                # Clean up old images (keep last 3)
                docker images ${IMAGE_NAME} --format "{{.Tag}}" | \
                    grep -v latest | \
                    tail -n +4 | \
                    xargs -r -I {} docker rmi ${IMAGE_NAME}:{} || true
            """
            cleanWs()
        }
        
        success {
            echo '========================================='
            echo "✅ ${SERVICE_NAME} BUILD SUCCESSFUL!"
            echo '========================================='
            echo "Image: ${IMAGE_NAME}:${IMAGE_TAG}"
            echo "Status: Deployed and healthy"
            echo "Time: ${currentBuild.durationString}"
            
            // Optional: Send notification
            // slackSend(color: 'good', message: "✅ ${SERVICE_NAME} v${IMAGE_TAG} deployed successfully")
        }
        
        failure {
            echo '========================================='
            echo "❌ ${SERVICE_NAME} BUILD FAILED!"
            echo '========================================='
            echo "Check logs: ${env.BUILD_URL}console"
            
            // Optional: Send notification
            // slackSend(color: 'danger', message: "❌ ${SERVICE_NAME} build #${BUILD_NUMBER} failed")
        }
        
        unstable {
            echo "⚠️ ${SERVICE_NAME} build is unstable"
        }
    }
}